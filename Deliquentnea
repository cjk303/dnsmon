#!/usr/bin/env bash
set -euo pipefail

# ==== CONFIG ====
TENANT="epiqglobal"  # Change if different
USERNAME="your.username@domain.com"
PASSWORD="yourpassword"
CLIENT_ID="your-client-id"
CLIENT_SECRET="your-client-secret"

TOKEN_URL="https://${TENANT}.delinea.app/SecretServer/oauth2/token"

# ==== REQUEST TOKEN ====
response=$(curl -s -X POST "$TOKEN_URL" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  --data-urlencode "grant_type=password" \
  --data-urlencode "username=${USERNAME}" \
  --data-urlencode "password=${PASSWORD}" \
  --data-urlencode "scope=system" \
  --data-urlencode "client_id=${CLIENT_ID}" \
  --data-urlencode "client_secret=${CLIENT_SECRET}"
)

# ==== DEBUG OUTPUT ====
echo "Raw response:"
echo "$response" | jq .

# ==== EXTRACT TOKEN ====
ACCESS_TOKEN=$(echo "$response" | jq -r '.access_token // empty')

if [[ -z "$ACCESS_TOKEN" ]]; then
  echo "❌ Failed to obtain access token — check username/password, client credentials, or scope permissions."
  exit 1
fi

echo
echo "✅ Access token:"
echo "$ACCESS_TOKEN"
