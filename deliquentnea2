#!/usr/bin/env bash
set -euo pipefail

# =========== CONFIGURATION ===========
TENANT="epiqglobal"
HOSTNAME="${TENANT}.delinea.app"
TOKEN_URL="https://${HOSTNAME}/identity/api/oauth2/token/xpmplatform"
SCOPE="xpmheadless"

CLIENT_ID="YOUR_CLIENT_ID"
CLIENT_SECRET="YOUR_CLIENT_SECRET"

SECRET_NAME="SVI_T1_PAM_SvrOps_15"
SECRET_DOMAIN="amer.epiqcorp.com"

# =========== GET ACCESS TOKEN ===========
echo "Requesting access token..."
token_response=$(curl --silent --location \
  --header "Content-Type: application/x-www-form-urlencoded" \
  --data-urlencode "grant_type=client_credentials" \
  --data-urlencode "scope=${SCOPE}" \
  --data-urlencode "client_id=${CLIENT_ID}" \
  --data-urlencode "client_secret=${CLIENT_SECRET}" \
  "${TOKEN_URL}")

access_token=$(echo "${token_response}" | jq -r '.access_token')

if [[ -z "${access_token}" || "${access_token}" == "null" ]]; then
  echo "Failed to obtain token:"
  echo "${token_response}"
  exit 1
fi

echo "Access token acquired."

# =========== FIND SECRET BY NAME ===========
echo "Searching for secret '${SECRET_NAME}' in domain '${SECRET_DOMAIN}'..."

search_response=$(curl --silent --location \
  --header "Authorization: Bearer ${access_token}" \
  "https://${HOSTNAME}/api/v1/secrets?filter.name=${SECRET_NAME}&filter.domainName=${SECRET_DOMAIN}")

secret_id=$(echo "${search_response}" | jq -r '.records[0].id // empty')

if [[ -z "${secret_id}" ]]; then
  echo "No matching secret found or no permission to view."
  echo "${search_response}" | jq .
  exit 1
fi

echo "Found secret ID: ${secret_id}"

# =========== GET SECRET PASSWORD ===========
echo "Retrieving password..."

fields_response=$(curl --silent --location \
  --header "Authorization: Bearer ${access_token}" \
  "https://${HOSTNAME}/api/v1/secrets/${secret_id}/fields")

password=$(echo "${fields_response}" | jq -r '.[] | select(.slug=="password") | .value')

if [[ -n "${password}" ]]; then
  echo "Password: ${password}"
else
  echo "Password field not found or not accessible."
  echo "${fields_response}" | jq .
fi
